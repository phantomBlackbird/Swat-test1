<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Subrural - Fixed Controls</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
    
    <style>
      .controller {
        position: absolute; bottom: 40px; width: 200px; height: 200px; z-index: 1000;
        display: grid; gap: 10px; pointer-events: auto;
      }
      #move-pad { left: 20px; grid-template-areas: ". up ." "left . right" ". down ."; }
      #action-pad { right: 20px; grid-template-areas: ". jump ." "grenade . reload" ". fire ."; }
      .btn {
        width: 60px; height: 60px; background: rgba(255, 255, 255, 0.4); border: 2px solid #fff;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 12px; font-weight: bold; color: white; user-select: none; touch-action: none;
      }
      .btn:active { background: rgba(255, 255, 255, 0.9); color: black; }
      #up { grid-area: up; } #left { grid-area: left; } #right { grid-area: right; } #down { grid-area: down; }
    </style>
  </head>
  <body>

    <div id="move-pad" class="controller">
      <div class="btn" id="up">FWD</div>
      <div class="btn" id="left">LFT</div>
      <div class="btn" id="right">RGT</div>
      <div class="btn" id="down">BWD</div>
    </div>

    <a-scene physics="debug: false; gravity: -9.8">
      <a-assets>
        <a-asset-item id="subrural" src="Subrural.glb"></a-asset-item>
        <a-asset-item id="player" src="Player.glb"></a-asset-item>
      </a-assets>

      <a-plane rotation="-90 0 0" width="1000" height="1000" color="#8B4513" static-body></a-plane>
      <a-entity gltf-model="#subrural" static-body="shape: mesh"></a-entity>
      <a-sky color="#87CEEB"></a-sky>

      <a-entity id="player-rig" position="0 0.05 0" kinematic-body="radius: 0.1">
        <a-entity id="player-model" 
                  gltf-model="#player" 
                  scale="0.0072 0.0072 0.0072" 
                  animation-mixer="clip: idle; crossFadeDuration: 0.2"
                  rotation="0 180 0">
        </a-entity>

        <a-entity id="camera-orbit-y">
          <a-entity id="camera-orbit-x">
            <a-entity camera position="0 1.5 3" look-controls="enabled: false"></a-entity>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity light="type: ambient; intensity: 0.7"></a-entity>
    </a-scene>

    <script>
      const rig = document.querySelector('#player-rig');
      const model = document.querySelector('#player-model');
      
      let moveKeys = { up: false, down: false, left: false, right: false };
      let isRunning = false;
      let holdTimer = null;

      // Reset and bind buttons
      const bind = (id, key) => {
        const el = document.getElementById(id);
        const start = (e) => { 
          e.preventDefault(); 
          moveKeys[key] = true; 
          if(!holdTimer) holdTimer = setTimeout(() => isRunning = true, 3000);
        };
        const end = () => { 
          moveKeys[key] = false; 
          isRunning = false; 
          clearTimeout(holdTimer); 
          holdTimer = null;
        };
        el.addEventListener('touchstart', start);
        el.addEventListener('touchend', end);
        el.addEventListener('mousedown', start);
        el.addEventListener('mouseup', end);
      };

      bind('up', 'up'); bind('down', 'down'); bind('left', 'left'); bind('right', 'right');

      function tick() {
        let speed = isRunning ? 0.12 : 0.04;
        let rot = rig.getAttribute('rotation');
        let angleRad = rot.y * (Math.PI / 180);
        let activeAnim = 'idle';

        // Movement Logic + Specific Animations
        if (moveKeys.up) {
          rig.object3D.position.x -= Math.sin(angleRad) * speed;
          rig.object3D.position.z -= Math.cos(angleRad) * speed;
          activeAnim = isRunning ? 'run-forward' : 'walk-forward';
        } else if (moveKeys.down) {
          rig.object3D.position.x += Math.sin(angleRad) * speed;
          rig.object3D.position.z += Math.cos(angleRad) * speed;
          activeAnim = isRunning ? 'run-backwards' : 'walk-backwards';
        } else if (moveKeys.left) {
          // Slide left relative to rotation
          rig.object3D.position.x -= Math.cos(angleRad) * speed;
          rig.object3D.position.z += Math.sin(angleRad) * speed;
          activeAnim = isRunning ? 'run-left' : 'walk-left';
        } else if (moveKeys.right) {
          // Slide right relative to rotation
          rig.object3D.position.x += Math.cos(angleRad) * speed;
          rig.object3D.position.z -= Math.sin(angleRad) * speed;
          activeAnim = isRunning ? 'run-right' : 'walk-right';
        }

        // Apply Animation only if changed to prevent freezing
        if (model.getAttribute('animation-mixer').clip !== activeAnim) {
          model.setAttribute('animation-mixer', `clip: ${activeAnim}`);
        }

        requestAnimationFrame(tick);
      }
      tick();
    </script>
  </body>
</html>
