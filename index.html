<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Subrural - Final Movement Fix</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
      .controller {
        position: absolute; bottom: 40px; width: 220px; height: 220px; z-index: 2000;
        display: grid; gap: 10px; pointer-events: auto;
      }
      #move-pad { left: 20px; grid-template-areas: ". up ." "left . right" ". down ."; }
      .btn {
        width: 70px; height: 70px; background: rgba(0, 0, 0, 0.5); border: 2px solid #fff;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 14px; font-weight: bold; color: white; user-select: none; touch-action: none;
      }
      .btn:active { background: rgba(255, 255, 255, 0.8); color: black; }
      #up { grid-area: up; } #left { grid-area: left; } #right { grid-area: right; } #down { grid-area: down; }
    </style>
  </head>
  <body>

    <div id="move-pad" class="controller">
      <div class="btn" id="up">FWD</div>
      <div class="btn" id="left">TURN L</div>
      <div class="btn" id="right">TURN R</div>
      <div class="btn" id="down">BWD</div>
    </div>

    <a-scene>
      <a-assets>
        <a-asset-item id="subrural" src="Subrural.glb"></a-asset-item>
        <a-asset-item id="player" src="Player.glb"></a-asset-item>
      </a-assets>

      <a-entity gltf-model="#subrural"></a-entity>
      <a-plane rotation="-90 0 0" width="1000" height="1000" color="#8B4513"></a-plane>
      <a-sky color="#87CEEB"></a-sky>

      <a-entity id="player-rig" position="0 0.05 0">
        
        <a-entity id="player-model" 
                  gltf-model="#player" 
                  scale="0.0072 0.0072 0.0072" 
                  animation-mixer="clip: idle; crossFadeDuration: 0.2"
                  rotation="0 180 0">
        </a-entity>

        <a-entity position="0 1.8 4">
            <a-entity camera look-controls="enabled: false"></a-entity>
        </a-entity>
      </a-entity>

      <a-entity light="type: ambient; intensity: 0.8"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="1 10 3"></a-entity>
    </a-scene>

    <script>
      const rig = document.querySelector('#player-rig');
      const model = document.querySelector('#player-model');
      
      let moveKeys = { up: false, down: false, left: false, right: false };
      let isRunning = false;
      let sprintTimer = null;

      // Improved Button Binding
      const setupButton = (id, key) => {
        const el = document.getElementById(id);
        const start = (e) => {
          e.preventDefault();
          moveKeys[key] = true;
          if (!sprintTimer) sprintTimer = setTimeout(() => { isRunning = true; }, 3000);
        };
        const end = (e) => {
          e.preventDefault();
          moveKeys[key] = false;
          isRunning = false;
          clearTimeout(sprintTimer);
          sprintTimer = null;
        };
        el.addEventListener('touchstart', start);
        el.addEventListener('touchend', end);
        el.addEventListener('mousedown', start);
        el.addEventListener('mouseup', end);
      };

      setupButton('up', 'up');
      setupButton('down', 'down');
      setupButton('left', 'left');
      setupButton('right', 'right');

      function tick() {
        // 1. Handle Rotation (Turn Left/Right)
        let rotation = rig.getAttribute('rotation');
        if (moveKeys.left) rotation.y += 2.5;
        if (moveKeys.right) rotation.y -= 2.5;
        rig.setAttribute('rotation', rotation);

        // 2. Handle Position (Forward/Backward)
        let position = rig.getAttribute('position');
        let speed = isRunning ? 0.12 : 0.05;
        let activeAnim = 'idle';

        if (moveKeys.up || moveKeys.down) {
          let direction = moveKeys.up ? 1 : -1;
          let angleRad = rotation.y * (Math.PI / 180);
          
          position.x -= Math.sin(angleRad) * speed * direction;
          position.z -= Math.cos(angleRad) * speed * direction;
          rig.setAttribute('position', position);

          activeAnim = direction === 1 ? (isRunning ? 'run-forward' : 'walk-forward') : (isRunning ? 'run-backwards' : 'walk-backwards');
        } else if (moveKeys.left || moveKeys.right) {
            // If just turning, we play a walk animation to show movement
            activeAnim = 'walk-forward';
        }

        // 3. Update Animation Mixer
        if (model.getAttribute('animation-mixer').clip !== activeAnim) {
          model.setAttribute('animation-mixer', `clip: ${activeAnim}`);
        }

        requestAnimationFrame(tick);
      }
      tick();
    </script>
  </body>
</html>
