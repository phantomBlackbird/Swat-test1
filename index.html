<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Subrural - Physics & Exploration</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
    
    <style>
      .controller {
        position: absolute; bottom: 40px; width: 160px; height: 160px; z-index: 100;
        display: grid; gap: 10px;
      }
      #move-pad { left: 40px; grid-template-areas: ". up ." "left . right" ". down ."; }
      #action-pad { right: 40px; grid-template-areas: ". jump ." "grenade . reload" ". fire ."; }
      .btn {
        width: 50px; height: 50px; background: rgba(255, 255, 255, 0.4); border: 2px solid #fff;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 10px; font-weight: bold; color: white; user-select: none; touch-action: none;
      }
      .btn:active { background: rgba(255, 255, 255, 0.8); color: black; }
      #up { grid-area: up; } #left { grid-area: left; } #right { grid-area: right; } #down { grid-area: down; }
      #jump { grid-area: jump; } #grenade { grid-area: grenade; } #reload { grid-area: reload; } #fire { grid-area: fire; }
    </style>
  </head>
  <body>

    <div id="move-pad" class="controller">
      <div class="btn" id="up">FWD</div>
      <div class="btn" id="left">L</div>
      <div class="btn" id="right">R</div>
      <div class="btn" id="down">BWD</div>
    </div>

    <div id="action-pad" class="controller">
      <div class="btn" id="jump">JUMP</div>
      <div class="btn" id="grenade">GREN</div>
      <div class="btn" id="reload">RLD</div>
      <div class="btn" id="fire">FIRE</div>
    </div>

    <a-scene physics="debug: false; gravity: -9.8">
      <a-assets>
        <a-asset-item id="subrural" src="Subrural.glb"></a-asset-item>
        <a-asset-item id="player" src="Player.glb"></a-asset-item>
      </a-assets>

      <a-entity gltf-model="#subrural" static-body></a-entity>
      <a-plane rotation="-90 0 0" width="500" height="500" color="#8B4513" static-body></a-plane>
      <a-sky color="#87CEEB"></a-sky>

      <a-entity id="player-rig" position="0 0.1 0" kinematic-body="radius: 0.05">
        
        <a-entity id="player-model" 
                  gltf-model="#player" 
                  scale="0.0024 0.0024 0.0024" 
                  animation-mixer="clip: idle; crossFadeDuration: 0.3"
                  rotation="0 180 0">
        </a-entity>

        <a-entity id="camera-orbit-y">
          <a-entity id="camera-orbit-x">
            <a-entity camera position="0 0.4 1.2" look-controls="enabled: false"></a-entity>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity light="type: ambient; intensity: 0.7"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="1 4 3"></a-entity>
    </a-scene>

    <script>
      const rig = document.querySelector('#player-rig');
      const model = document.querySelector('#player-model');
      const orbitY = document.querySelector('#camera-orbit-y');
      const orbitX = document.querySelector('#camera-orbit-x');

      let moveKeys = { up: false, down: false, left: false, right: false };
      let holdTimer = null;
      let isRunning = false;

      const startMove = (key) => {
        moveKeys[key] = true;
        if (!holdTimer) {
          holdTimer = setTimeout(() => { isRunning = true; }, 3000);
        }
      };

      const endMove = (key) => {
        moveKeys[key] = false;
        isRunning = false;
        clearTimeout(holdTimer);
        holdTimer = null;
      };

      ['up','down','left','right'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { e.preventDefault(); startMove(id); });
        el.addEventListener('touchend', () => endMove(id));
      });

      // Camera Swipe Logic
      let touchStart = { x: 0, y: 0 };
      window.addEventListener('touchstart', e => {
        if(e.touches[0]) { touchStart.x = e.touches[0].pageX; touchStart.y = e.touches[0].pageY; }
      });

      window.addEventListener('touchmove', e => {
        if (e.target.className.includes('btn')) return;
        let dx = e.touches[0].pageX - touchStart.x;
        let dy = e.touches[0].pageY - touchStart.y;
        
        let rotY = orbitY.getAttribute('rotation');
        let rotX = orbitX.getAttribute('rotation');

        orbitY.setAttribute('rotation', `0 ${rotY.y - dx * 0.5} 0`);
        orbitX.setAttribute('rotation', `${rotX.x - dy * 0.5} 0 0`);

        touchStart.x = e.touches[0].pageX;
        touchStart.y = e.touches[0].pageY;
      });

      function tick() {
        let isMoving = moveKeys.up || moveKeys.down || moveKeys.left || moveKeys.right;
        let speed = isRunning ? 0.008 : 0.003; 
        let rot = rig.getAttribute('rotation');
        let angleRad = rot.y * (Math.PI / 180);

        if (moveKeys.up) {
          rig.object3D.position.x -= Math.sin(angleRad) * speed;
          rig.object3D.position.z -= Math.cos(angleRad) * speed;
        }
        if (moveKeys.down) {
          rig.object3D.position.x += Math.sin(angleRad) * speed;
          rig.object3D.position.z += Math.cos(angleRad) * speed;
        }
        if (moveKeys.left) rot.y += 2;
        if (moveKeys.right) rot.y -= 2;
        rig.setAttribute('rotation', rot);

        let currentClip = model.getAttribute('animation-mixer').clip;
        if (isMoving) {
            let nextClip = isRunning ? 'run-forward' : 'walk-forward';
            if (currentClip !== nextClip) model.setAttribute('animation-mixer', 'clip: ' + nextClip);
        } else {
            if (currentClip !== 'idle') model.setAttribute('animation-mixer', 'clip: idle');
        }

        requestAnimationFrame(tick);
      }
      tick();
    </script>
  </body>
</html>
