<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Subrural - Advanced Controls</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
      .controller {
        position: absolute;
        bottom: 40px;
        width: 160px;
        height: 160px;
        z-index: 100;
        display: grid;
        grid-template-areas: ". up ." "left . right" ". down .";
        gap: 10px;
      }
      #move-pad { left: 40px; }
      #action-pad { 
        right: 40px; 
        grid-template-areas: ". jump ." "grenade . reload" ". fire .";
      }
      .btn {
        width: 50px; height: 50px;
        background: rgba(255, 255, 255, 0.4);
        border: 2px solid #fff;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 10px; font-weight: bold; color: white;
        user-select: none; touch-action: none;
      }
      .btn:active { background: rgba(255, 255, 255, 0.8); color: black; }
      #up { grid-area: up; } #left { grid-area: left; } #right { grid-area: right; } #down { grid-area: down; }
      #jump { grid-area: jump; } #grenade { grid-area: grenade; } #reload { grid-area: reload; } #fire { grid-area: fire; }
    </style>
  </head>
  <body>

    <div id="move-pad" class="controller">
      <div class="btn" id="up">FWD</div>
      <div class="btn" id="left">L</div>
      <div class="btn" id="right">R</div>
      <div class="btn" id="down">BWD</div>
    </div>

    <div id="action-pad" class="controller">
      <div class="btn" id="jump">JUMP</div>
      <div class="btn" id="grenade">GREN</div>
      <div class="btn" id="reload">RLD</div>
      <div class="btn" id="fire">FIRE</div>
    </div>

    <a-scene>
      <a-assets>
        <a-asset-item id="subrural" src="Subrural.glb"></a-asset-item>
        <a-asset-item id="player" src="Player.glb"></a-asset-item>
      </a-assets>

      <a-entity gltf-model="#subrural"></a-entity>
      <a-plane rotation="-90 0 0" width="200" height="200" color="#8B4513"></a-plane>
      <a-sky color="#87CEEB"></a-sky>

      <a-entity id="player-rig" position="0 0 0">
        <a-entity id="player-model" 
                  gltf-model="#player" 
                  scale="0.0008 0.0008 0.0008" 
                  animation-mixer="clip: idle; crossFadeDuration: 0.3"
                  rotation="0 180 0">
        </a-entity>

        <a-entity id="camera-orbit-y">
          <a-entity id="camera-orbit-x">
            <a-entity camera position="0 0.25 0.8" look-controls="enabled: false"></a-entity>
          </a-entity>
        </a-entity>
      </a-entity>

      <a-entity light="type: ambient; intensity: 0.7"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="1 4 3"></a-entity>
    </a-scene>

    <script>
      const rig = document.querySelector('#player-rig');
      const model = document.querySelector('#player-model');
      const orbitY = document.querySelector('#camera-orbit-y');
      const orbitX = document.querySelector('#camera-orbit-x');

      let moveKeys = { up: false, down: false, left: false, right: false };
      let holdTimer = null;
      let isRunning = false;

      // --- MOVEMENT LOGIC ---
      const startMove = (key) => {
        moveKeys[key] = true;
        if (!holdTimer) {
          holdTimer = setTimeout(() => { isRunning = true; }, 3000);
        }
      };

      const endMove = (key) => {
        moveKeys[key] = false;
        isRunning = false;
        clearTimeout(holdTimer);
        holdTimer = null;
      };

      ['up','down','left','right'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { e.preventDefault(); startMove(id); });
        el.addEventListener('touchend', () => endMove(id));
      });

      // --- ACTION LOGIC ---
      const triggerAction = (clipName) => {
        model.setAttribute('animation-mixer', { clip: clipName, loop: 'once', clampWhenFinished: true });
        model.addEventListener('finished', () => {
          model.setAttribute('animation-mixer', 'clip: idle');
        }, { once: true });
      };

      document.getElementById('jump').onclick = () => triggerAction('jump');
      document.getElementById('fire').onclick = () => triggerAction('shoot-rifle');
      document.getElementById('grenade').onclick = () => triggerAction('throw-grenade');
      document.getElementById('reload').onclick = () => triggerAction('reloading');

      // --- SWIPE CAMERA LOGIC ---
      let touchStart = { x: 0, y: 0 };
      window.addEventListener('touchstart', e => {
        touchStart.x = e.touches[0].pageX;
        touchStart.y = e.touches[0].pageY;
      });

      window.addEventListener('touchmove', e => {
        if (e.target.className.includes('btn')) return; // Don't rotate camera if clicking buttons
        let dx = e.touches[0].pageX - touchStart.x;
        let dy = e.touches[0].pageY - touchStart.y;
        
        let rotY = orbitY.getAttribute('rotation');
        let rotX = orbitX.getAttribute('rotation');

        orbitY.setAttribute('rotation', `${rotY.x} ${rotY.y - dx * 0.5} ${rotY.z}`);
        orbitX.setAttribute('rotation', `${rotX.x - dy * 0.5} ${rotX.y} ${rotX.z}`);

        touchStart.x = e.touches[0].pageX;
        touchStart.y = e.touches[0].pageY;
      });

      function tick() {
        let isMoving = moveKeys.up || moveKeys.down || moveKeys.left || moveKeys.right;
        let speed = isRunning ? 0.003 : 0.0012;
        let rot = rig.getAttribute('rotation');
        let angleRad = rot.y * (Math.PI / 180);

        if (moveKeys.up) {
          rig.object3D.position.x -= Math.sin(angleRad) * speed;
          rig.object3D.position.z -= Math.cos(angleRad) * speed;
        }
        if (moveKeys.down) {
          rig.object3D.position.x += Math.sin(angleRad) * speed;
          rig.object3D.position.z += Math.cos(angleRad) * speed;
        }
        if (moveKeys.left) rot.y += 2;
        if (moveKeys.right) rot.y -= 2;
        rig.setAttribute('rotation', rot);

        // Animation update
        let currentClip = model.getAttribute('animation-mixer').clip;
        if (isMoving && !['jump','shoot-rifle','throw-grenade','reloading'].includes(currentClip)) {
            let nextClip = isRunning ? 'run-forward' : 'walk-forward';
            if (currentClip !== nextClip) model.setAttribute('animation-mixer', 'clip: ' + nextClip);
        } else if (!isMoving && (currentClip === 'walk-forward' || currentClip === 'run-forward')) {
            model.setAttribute('animation-mixer', 'clip: idle');
        }

        requestAnimationFrame(tick);
      }
      tick();
    </script>
  </body>
</html>
