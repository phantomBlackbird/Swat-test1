<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Subrural Game - Full Body View</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
      #dpad {
        position: absolute;
        bottom: 40px;
        left: 40px;
        width: 160px;
        height: 160px;
        z-index: 100;
        display: grid;
        grid-template-areas: ". up ." "left . right" ". down .";
        gap: 10px;
      }
      .btn {
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.5);
        border: 2px solid #fff;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        user-select: none;
        touch-action: none;
      }
      .btn:active { background: rgba(255, 255, 255, 0.8); }
      #up { grid-area: up; }
      #left { grid-area: left; }
      #right { grid-area: right; }
      #down { grid-area: down; }
    </style>
  </head>
  <body>

    <div id="dpad">
      <div class="btn" id="up">▲</div>
      <div class="btn" id="left">◀</div>
      <div class="btn" id="right">▶</div>
      <div class="btn" id="down">▼</div>
    </div>

    <a-scene>
      <a-assets>
        <a-asset-item id="subrural-model" src="Subrural.glb"></a-asset-item>
        <a-asset-item id="player-model" src="Player.glb"></a-asset-item>
      </a-assets>

      <a-entity gltf-model="#subrural-model" position="0 0 0"></a-entity>
      <a-plane position="0 0 0" rotation="-90 0 0" width="200" height="200" color="#8B4513"></a-plane>
      <a-sky color="#87CEEB"></a-sky>

      <a-entity id="player-rig" position="0 0 0">
        
        <a-entity id="player-model-entity" 
                  gltf-model="#player-model" 
                  scale="0.0026 0.0026 0.0026"
                  animation-mixer="clip: idle"
                  rotation="0 180 0">
        </a-entity>

        <a-entity id="camera-parent">
           <a-entity id="main-camera" camera position="0 0.15 0.4" look-controls="enabled: false">
           </a-entity>
        </a-entity>
        
      </a-entity>

      <a-entity light="type: ambient; intensity: 0.7"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="1 4 3"></a-entity>
    </a-scene>

    <script>
      const rig = document.querySelector('#player-rig');
      const model = document.querySelector('#player-model-entity');
      
      let keys = { up: false, down: false, left: false, right: false };
      const moveSpeed = 0.0015; // Slowed down for smaller scale
      const rotationSpeed = 2;

      const setupButton = (id, key) => {
        const el = document.getElementById(id);
        const start = () => { keys[key] = true; };
        const end = () => { keys[key] = false; };
        el.addEventListener('touchstart', start);
        el.addEventListener('touchend', end);
        el.addEventListener('mousedown', start);
        el.addEventListener('mouseup', end);
      };

      setupButton('up', 'up');
      setupButton('down', 'down');
      setupButton('left', 'left');
      setupButton('right', 'right');

      function tick() {
        let isMoving = false;
        let currentRotation = rig.getAttribute('rotation');

        if (keys.left) currentRotation.y += rotationSpeed;
        if (keys.right) currentRotation.y -= rotationSpeed;
        rig.setAttribute('rotation', currentRotation);

        if (keys.up || keys.down) {
          isMoving = true;
          const direction = keys.up ? 1 : -1;
          const angleRad = currentRotation.y * (Math.PI / 180);
          const pos = rig.getAttribute('position');
          
          pos.x -= Math.sin(angleRad) * moveSpeed * direction;
          pos.z -= Math.cos(angleRad) * moveSpeed * direction;
          rig.setAttribute('position', pos);
        }

        const targetAnim = isMoving ? 'walk-forward' : 'idle';
        if (model.getAttribute('animation-mixer').clip !== targetAnim) {
          model.setAttribute('animation-mixer', `clip: ${targetAnim}`);
        }

        requestAnimationFrame(tick);
      }
      tick();
    </script>
  </body>
</html>
